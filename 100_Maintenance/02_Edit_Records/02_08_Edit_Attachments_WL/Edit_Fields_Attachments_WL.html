<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attachments_WL Table Editor</title>
<style>
body { font-family: Arial; background: #111; color: #ff9900; padding: 20px; }
h1 { text-align: center; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #222; border: 2px solid #ff9900; border-radius: 10px; overflow: hidden; }
th, td { padding: 10px; border-bottom: 1px solid #444; }
th { background: #333; text-align: left; }
input, select { width: 95%; padding: 6px; background: #000; border: 1px solid #ff9900; border-radius: 6px; color: #ff9900; }
button { background: #ff9900; color: #000; font-weight: bold; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
button:hover { background: #ffaa22; }
.delete-btn { background: #cc0000; color: white; }
.delete-btn:hover { background: #ff0000; }
.edit-btn { background: #1e90ff; color: #fff; }
.edit-btn:hover { background: #3aa0ff; }
#messageBox { font-weight: bold; margin-top: 10px; height: 20px; }
</style>
</head>
<body>

<h1>Attachments_WL Table Editor</h1>

<table id="fieldsTable">
<thead>
<tr>
<th>Field Name</th>
<th>Field Type</th>
<th>Action</th>
</tr>
</thead>
<tbody id="fieldsBody"></tbody>
</table>

<h3>Add New Field</h3>
<input type="text" id="newFieldName" placeholder="Field name">
<select id="newFieldType">
<option value="String">String</option>
<option value="Numeric">Numeric</option>
<option value="Boolean">Boolean</option>
<option value="Array">Array</option>
</select>
<button id="addFieldBtn">Add Field</button>

<div id="messageBox"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { 
getFirestore, collection, getDocs, doc, updateDoc, deleteField, setDoc
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
apiKey: "YOUR_API_KEY",
authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
projectId: "attachments-df167",
storageBucket: "attachments-df167.appspot.com",
messagingSenderId: "YOUR_SENDER_ID",
appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const AttachmentsCol = collection(db, "Attachments_WL");

// =========================================
//      SANITIZE FIELD NAMES
// =========================================
function sanitizeFieldName(name){
    return name.replace(/[~*\/\[\]]/g,"_");
}

// =========================================
//            LOAD TABLE
// =========================================
async function loadTable() {
    try {
        const snapshot = await getDocs(AttachmentsCol);
        const tbody = document.getElementById("fieldsBody");
        tbody.innerHTML = "";

        if(snapshot.empty){
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.textContent = "No fields found in the collection.";
            td.style.textAlign = "center";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        // Collect all unique fields
        const uniqueFields = new Set();
        snapshot.docs.forEach(d => Object.keys(d.data()).forEach(k=>uniqueFields.add(k)));
        const sortedFields = Array.from(uniqueFields).sort();

        sortedFields.forEach(fieldName=>{
            const tr = document.createElement("tr");

            // FIELD NAME
            const tdName = document.createElement("td");
            const inputName = document.createElement("input");
            inputName.type = "text";
            inputName.value = fieldName;
            inputName.disabled = true;
            tdName.appendChild(inputName);
            tr.appendChild(tdName);

            // FIELD TYPE
            const tdType = document.createElement("td");
            const selectType = document.createElement("select");
            ["String","Numeric","Boolean","Array"].forEach(opt=>{
                const o = document.createElement("option"); o.value=opt;o.textContent=opt;
                selectType.appendChild(o);
            });
            selectType.value = detectFieldType(snapshot, fieldName);
            selectType.disabled = true;
            tdType.appendChild(selectType);
            tr.appendChild(tdType);

            // ACTIONS
            const tdAction = document.createElement("td");

            // EDIT
            const editBtn = document.createElement("button");
            editBtn.textContent="Edit"; editBtn.classList.add("edit-btn");
            editBtn.addEventListener("click", async ()=>{
                if(editBtn.textContent==="Edit"){
                    inputName.disabled=false; selectType.disabled=false; inputName.focus();
                    editBtn.textContent="Save";
                } else {
                    const newFieldName = inputName.value.trim();
                    if(!newFieldName){ showMessage("Field name cannot be empty.", true); return;}
                    await renameFieldAcrossDocs(fieldName, newFieldName, selectType.value);
                    editBtn.textContent="Edit";
                }
            });

            // DELETE
            const delBtn = document.createElement("button");
            delBtn.textContent="Delete"; delBtn.classList.add("delete-btn");
            const fieldToDelete = fieldName;
            delBtn.addEventListener("click", async ()=>{
                await sanitizeAndDelete(fieldToDelete);
            });

            tdAction.appendChild(editBtn);
            tdAction.appendChild(delBtn);
            tr.appendChild(tdAction);

            tbody.appendChild(tr);
        });

    } catch(err){
        console.error(err);
        showMessage("Failed to load Attachments_WL.", true);
    }
}

// =========================================
//       SANITIZE & DELETE FIELD
// =========================================
async function sanitizeAndDelete(fieldName){
    if(!fieldName) return showMessage("Field name is empty.", true);
    if(!confirm(`Delete field "${fieldName}" from all documents?`)) return;

    const sanitized = sanitizeFieldName(fieldName);

    try{
        const snapshot = await getDocs(AttachmentsCol);
        if(snapshot.empty){ showMessage("No documents to delete from.", true); return;}
        for(const d of snapshot.docs){
            const data = d.data();
            const ref = doc(db,"Attachments_WL",d.id);

            // Rename if necessary
            if(data.hasOwnProperty(fieldName) && fieldName!==sanitized){
                await updateDoc(ref, {[sanitized]: data[fieldName]});
                await updateDoc(ref, {[fieldName]: deleteField()});
            }
            // Delete safe fields
            else if(data.hasOwnProperty(fieldName)){
                await updateDoc(ref, {[fieldName]: deleteField()});
            }
        }
        showMessage(`Field "${fieldName}" deleted successfully.`, false);
        await loadTable();
    } catch(err){
        console.error("Delete error:", err);
        showMessage(`Failed to delete field. ${err.message}`, true);
    }
}

// =========================================
//       RENAME FIELD ACROSS DOCUMENTS
// =========================================
async function renameFieldAcrossDocs(oldName,newName,newType=null){
    const sanitizedNew = sanitizeFieldName(newName);
    try{
        const snapshot = await getDocs(AttachmentsCol);
        for(const d of snapshot.docs){
            const data = d.data();
            const ref = doc(db,"Attachments_WL",d.id);
            if(data.hasOwnProperty(oldName)){
                let value = data[oldName];
                if(newType) value = convertType(value,newType);

                await updateDoc(ref,{ [sanitizedNew]: value });
                if(oldName!==sanitizedNew) await updateDoc(ref,{ [oldName]: deleteField() });
            }
        }
        showMessage(`Renamed "${oldName}" → "${sanitizedNew}"`, false);
        await loadTable();
    } catch(err){
        console.error("Rename error:", err);
        showMessage(`Failed to rename field. ${err.message}`, true);
    }
}

// =========================================
//            ADD FIELD
// =========================================
async function addField(){
    const nameInput = document.getElementById("newFieldName");
    const typeInput = document.getElementById("newFieldType");
    let fieldName = sanitizeFieldName(nameInput.value.trim());
    const fieldType = typeInput.value;
    if(!fieldName){ showMessage("Field name cannot be empty.", true); return;}
    let defaultValue = fieldType==="String"? "": fieldType==="Numeric"?0: fieldType==="Boolean"?false: [];
    try{
        const snapshot = await getDocs(AttachmentsCol);
        if(snapshot.empty){ showMessage("No documents in collection. Add a document first!", true); return;}
        for(const d of snapshot.docs){
            const ref = doc(db,"Attachments_WL",d.id);
            await setDoc(ref,{ [fieldName]: defaultValue },{ merge:true });
        }
        nameInput.value="";
        showMessage(`Field "${fieldName}" added successfully!`, false);
        await loadTable();
    } catch(err){
        console.error(err);
        showMessage("Failed to add field.", true);
    }
}

document.getElementById("addFieldBtn").addEventListener("click", addField);

// =========================================
//            HELPERS
// =========================================
function convertType(value,newType){
    switch(newType){
        case "String": return String(value);
        case "Numeric": return Number(value)||0;
        case "Boolean": return Boolean(value);
        case "Array": return Array.isArray(value)?value:[value];
        default: return value;
    }
}

function detectFieldType(snapshot,fieldName){
    for(const d of snapshot.docs){
        const val = d.data()[fieldName];
        if(val!==undefined){
            if(typeof val==="string") return "String";
            if(typeof val==="number") return "Numeric";
            if(typeof val==="boolean") return "Boolean";
            if(Array.isArray(val)) return "Array";
        }
    }
    return "String";
}

// =========================================
//            MESSAGE SYSTEM
// =========================================
function showMessage(msg,isError=false){
    const box = document.getElementById("messageBox");
    box.textContent=msg;
    box.style.color=isError?"red":"lightgreen";
}

// INITIAL LOAD
loadTable();

</script>

<footer style="margin-top:20px;">
<button onclick="window.location.href='../../../02_Maintenance.html'"
style="background: #e58e1a; color: #000; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
⬅ Back to Home
</button>
</footer>

</body>
</html>
